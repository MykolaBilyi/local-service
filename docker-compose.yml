services:
  certs:
    build:
      dockerfile_inline: |
        FROM alpine:3

        ARG PASS=pass
        ARG CA_SUBJECT="/C=US/ST=Denial/L=Springfield/O=Dis/CN=Local Root CA"
        ARG CERT_SUBJECT=/C=US/ST=Denial/L=Springfield/O=Dis/CN=*.service.local
        ARG CERT_EXTENSIONS=subjectAltName=DNS:*.service.local
        
        RUN apk add --no-cache openssl && \
            mkdir -p /opt/certs
        WORKDIR /opt/certs

        # Generate Local CA
        RUN \
            # Generate CA key 
            openssl genrsa -aes256 -passout pass:$$PASS -out ca.key 4096 && \
            # Generate CA cert 
            openssl req -x509 -new -nodes -key ca.key -passin pass:$$PASS -sha256 -days 3650 -out ca.crt -subj "$$CA_SUBJECT" && \
            # Generate Server Key
            openssl genrsa -out server.key 2048 && \
            # Generate Server CSR
            openssl req -new -key server.key -out server.csr -subj "$$CERT_SUBJECT" && \
            # Generate Server Cert
            openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -passin pass:$$PASS -CAcreateserial -out server.crt -days 825 -sha256 \
                -extfile <(echo "$$CERT_EXTENSIONS") && \
            # Clean up       
            rm -f ca.key server.csr
        
        VOLUME /certs
        VOLUME /trusted
        CMD ["sh", "-c", " \
          cp -u /opt/certs/server.key /opt/certs/server.crt /certs; \
          cp -u /opt/certs/ca.crt /trusted; \
        "]
    volumes:
    - certs:/certs
    - trusted:/trusted
  proxy:
    image: nginx:alpine
    configs:
    - source: nginx_conf
      target: /etc/nginx/conf.d/default.conf
    volumes:
    - certs:/etc/nginx/certs
    ports:
    - 127.0.0.1:80:80
    - 127.0.0.1:443:443
    networks:
    - services
    depends_on:
    - certs
    restart: always
  dns:
    image: dockurr/dnsmasq
    ports:
    - 127.0.0.1:53:53/udp
    - 127.0.0.1:53:53/tcp
    configs:
    - source: dnsmasq_conf
      target: /etc/dnsmasq.conf
    restart: always

networks:
  services:
    name: services

configs:
  nginx_conf:
    file: ./nginx.conf
  dnsmasq_conf:
    file: ./dnsmasq.conf

volumes:
  certs:
  trusted:
